import { BoletosService } from './services/boletos.service';
import { ItauConfig } from './config/itau.config';
import clientesData from './data/clientes.json';
import { Cliente } from './types';

/**
 * Arquivo principal demonstrando o fluxo completo de integraÃ§Ã£o
 * 
 * Fluxo:
 * 1. Valida credenciais
 * 2. Gera tokens necessÃ¡rios
 * 3. Faz requisiÃ§Ãµes autenticadas Ã  API
 */
async function main() {
  console.log('ğŸš€ Iniciando aplicaÃ§Ã£o Boletos ItaÃº\n');
  console.log('=' .repeat(60));
  
  try {
    // Exibe configuraÃ§Ãµes (sem expor secrets)
    console.log('\nğŸ“‹ ConfiguraÃ§Ãµes:');
    console.log(`   Sandbox URL: ${ItauConfig.sandboxUrl}`);
    console.log(`   OAuth URL: ${ItauConfig.oauthUrl}`);
    console.log(`   Client ID: ${ItauConfig.clientId.substring(0, 8)}...`);
    console.log('');

    // Inicializa o serviÃ§o de boletos
    const boletosService = new BoletosService();

    // AÃ‡ÃƒO 1: Valida credenciais (resolve API Key automaticamente usando CLIENT_ID)
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    console.log('âœ… AÃ‡ÃƒO 1: Validando Credenciais (resolvendo API Key automaticamente)...');
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    console.log('   ğŸ”„ Resolvendo API Key automaticamente usando CLIENT_ID...');
    console.log('');
    
    const credenciais = await boletosService.validarCredenciais(true); // true = resolve automaticamente
    console.log('   âœ“ CLIENT_ID:', credenciais.clientId ? 'âœ… Configurado' : 'âŒ NÃ£o configurado');
    console.log('   âœ“ CLIENT_SECRET:', credenciais.clientSecret ? 'âœ… Configurado' : 'âŒ NÃ£o configurado');
    console.log('   âœ“ API_KEY:', credenciais.apiKey ? 'âœ… Resolvida automaticamente' : 'âŒ NÃ£o resolvida');
    
    if (credenciais.apiKey) {
      console.log(`   ğŸ’¡ API Key resolvida: ${ItauConfig.apiKey.substring(0, 10)}... (usando CLIENT_ID)`);
    }
    
    console.log('   Status geral:', credenciais.todasValidadas ? 'âœ… Todas validadas' : 'âŒ Faltando credenciais');
    console.log('');

    // AÃ‡ÃƒO 2: Gera tokens necessÃ¡rios
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    console.log('âœ… AÃ‡ÃƒO 2: Gerando Tokens NecessÃ¡rios...');
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    
    const tokens = await boletosService.gerarTokens();
    console.log('   âœ“ Token OAuth:', tokens.oauthToken.substring(0, 30) + '...');
    console.log('   âœ“ API Key:', tokens.apiKey.substring(0, 10) + '...');
    console.log('   âœ“ Correlation ID:', tokens.correlationId);
    console.log('   âœ“ Headers preparados:', 'âœ… Prontos para uso');
    console.log('');

    // AÃ‡ÃƒO 3: Pronto para fazer requisiÃ§Ãµes autenticadas
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    console.log('âœ… AÃ‡ÃƒO 3: Sistema Pronto para RequisiÃ§Ãµes Autenticadas');
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    console.log('');
    console.log('ğŸ“¤ Exemplo de uso:');
    console.log('');
    console.log('   // Criar um boleto');
    console.log('   const boleto = await boletosService.criarBoleto({');
    console.log('     clienteId: "123",');
    console.log('     valor: 100.50,');
    console.log('     dataVencimento: "2026-02-20",');
    console.log('     descricao: "Pagamento de serviÃ§os"');
    console.log('   });');
    console.log('');
    console.log('   // Consultar um boleto');
    console.log('   const boletoConsultado = await boletosService.consultarBoleto("123456");');
    console.log('');
    console.log('   // RequisiÃ§Ã£o customizada');
    console.log('   const resultado = await boletosService.requisicaoAutenticada(');
    console.log('     "GET",');
    console.log('     "/boletos"');
    console.log('   );');
    console.log('');

    // Status do serviÃ§o
    const status = boletosService.getStatus();
    console.log('ğŸ“Š Status do ServiÃ§o:');
    console.log(`   Inicializado: ${status.initialized ? 'âœ…' : 'âŒ'}`);
    console.log(`   Token OAuth em cache: ${status.hasOAuthToken ? 'âœ…' : 'âŒ'}`);
    if (status.oauthTokenExpiresAt) {
      console.log(`   Token expira em: ${status.oauthTokenExpiresAt.toLocaleString('pt-BR')}`);
    }
    console.log('');

    // Exibe informaÃ§Ãµes sobre os clientes fictÃ­cios
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    console.log('ğŸ‘¥ Clientes DisponÃ­veis para Testes:');
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    const clientes: Cliente[] = clientesData as Cliente[];
    clientes.forEach((cliente, index) => {
      console.log(`\n   ${index + 1}. ${cliente.nome} (${cliente.tipo})`);
      console.log(`      ID: ${cliente.id}`);
      console.log(`      Documento: ${cliente.documento}`);
      console.log(`      Email: ${cliente.email}`);
      console.log(`      Cidade: ${cliente.endereco.cidade}/${cliente.endereco.estado}`);
    });
    console.log('');

    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    console.log('âœ¨ Sistema configurado e pronto para uso!');
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    console.log('');

  } catch (error) {
    console.error('\nâŒ Erro:', error instanceof Error ? error.message : error);
    console.log('\nğŸ’¡ Verifique:');
    console.log('   1. Se todas as credenciais estÃ£o configuradas no arquivo .env');
    console.log('   2. Se as credenciais estÃ£o corretas');
    console.log('   3. Se hÃ¡ conexÃ£o com a internet');
    process.exit(1);
  }
}

// Executa a aplicaÃ§Ã£o
if (require.main === module) {
  main();
}
